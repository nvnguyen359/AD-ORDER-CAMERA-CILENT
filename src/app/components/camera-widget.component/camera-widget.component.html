<div class="camera-card flex flex-column border-round-none shadow-none surface-card h-full"
  [ngClass]="{
    'status-idle': !orderCode() && !isBuffering(),
    'status-buffering': isBuffering(),
    'status-packing': orderCode() && !isTimeoutWarning(),
    'status-warning': isTimeoutWarning()
  }">

  <div class="header flex justify-content-between align-items-center p-3 bg-gray-900 text-white border-bottom-1 border-gray-800">

    <div class="flex align-items-center gap-2 overflow-hidden">
      <i class="pi pi-camera text-xl text-primary-400 flex-shrink-0"></i>
      <span class="font-bold text-lg white-space-nowrap">{{ cameraName }}</span>

      <span class="px-2 py-1 border-round text-xs font-bold transition-colors flex-shrink-0"
        [class.bg-green-500]="isStreaming()" [class.bg-red-500]="!isStreaming()">
        {{ isStreaming() ? 'LIVE' : 'OFFLINE' }}
      </span>
    </div>

    <div class="flex align-items-center gap-2">

      <div *ngIf="qrCode!=''" class="qr-code ml-2" pTooltip="Mã hiện tại" tooltipPosition="bottom">
        <i class="pi pi-qrcode text-lg"></i>
        <div >{{qrCode}}</div>
      </div>

      <div *ngIf="scannedCode()"
        class="scan-result-badge px-2 py-1 border-round-sm text-white font-bold text-sm flex align-items-center gap-2 animate-scan-pulse cursor-pointer"
        pTooltip="Mã vừa quét" tooltipPosition="bottom">
        <i class="pi pi-qrcode text-xs"></i>
        <span>{{ scannedCode() }}</span>
      </div>

      <div *ngIf="orderCode()"
        class="px-3 py-1 border-round-md bg-bluegray-700 text-white font-bold text-sm shadow-2 flex align-items-center gap-2 animate-order-pulse"
        pTooltip="Đơn hàng đang xử lý" tooltipPosition="bottom">
        <i class="pi pi-box text-xs"></i>
        <span>{{ orderCode() }}</span>
      </div>

      <div *ngIf="isRecording()" class="flex align-items-center gap-2 text-red-500 animate-pulse flex-shrink-0 ml-2">
        <i class="pi pi-circle-fill text-xs"></i>
        <span class="font-bold text-sm">
          {{ recordingState() === 'AUTO' ? 'REC (AUTO)' : 'REC' }}
        </span>
      </div>
    </div>

  </div>

  <div #viewport class="viewport relative bg-black overflow-hidden group select-none"
    (mousemove)="onUserInteraction()"
    (mouseleave)="onMouseLeave()"
    (click)="onViewportClick($event)">

    <div class="loading-layer" [class.hidden]="!isLoading()">
      <div class="flex flex-column align-items-center gap-3">
        <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
      </div>
    </div>

    <div *ngIf="!isStreaming() && !isLoading()"
      class="offline-state absolute top-0 left-0 w-full h-full flex justify-content-center align-items-center bg-black-alpha-90">
      <i class="pi pi-video text-8xl text-gray-800 opacity-20"></i>
    </div>

    <div
      class="play-overlay absolute top-0 left-0 w-full h-full flex justify-content-center align-items-center pointer-events-none transition-opacity duration-300"
      [class.opacity-0]="isStreaming() && !showControls()" [class.opacity-100]="!isStreaming() || showControls()">
      <div
        class="play-btn bg-black-alpha-50 border-circle w-5rem h-5rem flex justify-content-center align-items-center border-2 border-white-alpha-30 backdrop-blur-sm shadow-4">
        <i class="pi text-4xl text-white" [class.pi-play]="!isStreaming()" [class.pi-pause]="isStreaming()"></i>
      </div>
    </div>

    <div *ngIf="orderCode() && timeoutPercent() > 0" class="timeout-bar-container">
        <div class="timeout-bar" [style.width.%]="timeoutPercent()"></div>
    </div>

    <div *ngIf="isTimeoutWarning()" class="overlay-warning animate-fade-in">
        <div class="warning-box animate-pulse">
            <i class="pi pi-exclamation-triangle"></i>
            <span class="title">SẮP ĐÓNG ĐƠN!</span>
            <div class="subtitle">Vui lòng xuất hiện trước Camera</div>
        </div>
    </div>

    <ng-container *ngIf="isStreaming()">
      <img [src]="streamUrl()" (load)="onImageLoad($event)" (error)="onImageError($event)"
        class="video-layer absolute top-0 left-0 w-full h-full object-contain" alt="Stream">
      <canvas appVisualizer [metadata]="visibleOverlayData()" [imgWidth]="imgWidth()" [imgHeight]="imgHeight()"
        mode="both" class="overlay-layer absolute top-0 left-0 w-full h-full object-contain pointer-events-none">
      </canvas>
    </ng-container>

  </div>

  <div class="footer flex justify-content-between align-items-center p-2 bg-gray-900 border-top-1 border-gray-800"
    (click)="$event.stopPropagation()">

    <div class="mode-selector">
      <p-select [options]="viewOptions" [ngModel]="viewMode()" (onChange)="viewMode.set($event.value)"
        optionLabel="label" optionValue="value" [disabled]="!isStreaming()" appendTo="body" styleClass="custom-select"
        panelStyleClass="custom-select-panel">

        <ng-template pTemplate="selectedItem" let-selected>
          <div class="flex align-items-center gap-2" *ngIf="selected">
            <i [class]="selected.icon"></i>
            <span class="font-bold text-sm">{{ selected.label }}</span>
          </div>
        </ng-template>

        <ng-template pTemplate="item" let-option>
          <div class="flex align-items-center gap-2">
            <i [class]="option.icon"></i>
            <span class="text-sm">{{ option.label }}</span>
          </div>
        </ng-template>

      </p-select>
    </div>

    <div class="flex gap-2">
      <button class="p-button p-component p-button-rounded p-button-text" [class]="recordBtnClass()"
        [disabled]="!isStreaming()" [pTooltip]="recordBtnTooltip()" tooltipPosition="top"
        (click)="toggleRecording($event)">
        <i [class]="recordBtnIcon()"></i>
      </button>

      <button class="p-button p-component p-button-rounded p-button-text p-button-secondary" [disabled]="!isStreaming()"
        (click)="toggleFullscreen($event)" pTooltip="Toàn màn hình" tooltipPosition="top">
        <i [class]="isFullscreen() ? 'pi pi-times' : 'pi pi-expand'"></i>
      </button>
    </div>
  </div>
</div>

<p-toast position="top-center" [baseZIndex]="99999" styleClass="custom-toast" style="top: 100px!important;"></p-toast>
