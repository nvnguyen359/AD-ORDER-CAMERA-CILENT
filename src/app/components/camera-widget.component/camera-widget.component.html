<div class="cam-card" [class.recording]="isRecording()">

  <div class="cam-header">
    <div class="header-left">
      <strong>üì∏ Cam {{ cameraId }}</strong>
    </div>

    <div class="header-right">
      @if (isRecording()) {
        <span class="badge-rec">‚óè REC</span>
      }
<button class="btn-icon rec-btn"
              (click)="toggleRecording()"
              [title]="isRecording() ? 'D·ª´ng ghi h√¨nh' : 'Ghi h√¨nh th·ªß c√¥ng'">
        <i class="pi"
           [class.pi-circle-fill]="!isRecording()"
           [class.pi-stop-circle]="isRecording()"
           [style.color]="isRecording() ? '#e74c3c' : '#fff'">
        </i>
      </button>
      <select (change)="changeMode($event)" class="mode-select">
        <option value="normal">Normal</option>
        <option value="scan">üü¶ QR Scan</option>
        <option value="security">üü• Security</option>
        <option value="both">üü™ All</option>
      </select>

      <button class="btn-icon" (click)="toggleFullscreen()" title="To√†n m√†n h√¨nh">
        ‚õ∂
      </button>
    </div>
  </div>

  <div class="viewport" #viewport>

    @if (isFullscreen()) {
      <button class="exit-fullscreen-btn" (click)="toggleFullscreen()">
        ‚ùå Thu nh·ªè
      </button>
    }

    @if (imageBase64()) {
      <img [src]="imageBase64()" (load)="onImageLoad($event)" alt="Live">
    } @else {
      <div class="placeholder">
        @if (isStreaming()) {
            <p>ƒêang t·∫£i...</p>
        } @else {
            <i class="pi pi-camera" style="font-size: 3rem; color: #444;"></i>
        }
      </div>
    }

<canvas appVisualizer
            [width]="imgWidth()"
            [height]="imgHeight()"
            [metadata]="metadata()"
            [imgWidth]="imgWidth()"
            [imgHeight]="imgHeight()"
            [mode]="currentMode()"> </canvas>
    <div class="center-controls" (click)="toggleStream()">
        @if (!isStreaming()) {
            <button class="yt-play-btn ghost-mode">
                <i class="pi pi-play" style="font-size: 2.5rem; margin-left: 6px;"></i>
            </button>
        } @else {
            <button class="yt-pause-btn">
                <i class="pi pi-pause" style="font-size: 2rem;"></i>
            </button>
        }
    </div>

    @if (currentOrder(); as order) {

        @if (!isStreaming()) {
            <div class="offline-info-card" (click)="toggleStream()">
                <div class="card-header">
                    <span class="status-dot"></span> ƒêang x·ª≠ l√Ω
                </div>
                <div class="card-body">
                    <div class="row code">{{ order.code }}</div>
                    <div class="row note-group">
                        <span class="status-label">{{ order.status || 'Processing' }}</span>
                        @if (displayNote()) {
                             <span class="divider">‚Ä¢</span>
                             <span class="note-text">{{ displayNote() }}</span>
                        }
                    </div>
                    <div class="row time">‚è± {{ elapsedMinutes() }} ph√∫t tr∆∞·ªõc</div>
                </div>
            </div>
        }

        @if (isStreaming()) {
            @if (!showOnlineInfo()) {
                <button class="restore-info-btn" (click)="showOnlineInfo.set(true)" title="Hi·ªán th√¥ng tin">
                    ‚ÑπÔ∏è
                </button>
            }

            @if (showOnlineInfo()) {
                <div class="online-info-stack">
                    <button class="close-stack-btn" (click)="showOnlineInfo.set(false)">√ó</button>
                    <div class="stack-code">{{ order.code }}</div>
                    <div class="stack-meta">
                        <span class="meta-status">{{ order.status || 'Processing' }}</span>
                        <span class="meta-time">‚è± {{ elapsedMinutes() }}m</span>
                    </div>
                    @if (displayNote()) {
                        <div class="stack-note">{{ displayNote() }}</div>
                    }
                </div>
            }
        }
    }

  </div>
</div>
