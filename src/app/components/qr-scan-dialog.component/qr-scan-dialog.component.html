<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  header="Quét mã QR"
  styleClass="qr-dialog-custom"
  (onHide)="onHideDialog()"
  [style]="{ width: '90vw', maxWidth: '450px' }">

  <div class="scanner-container relative overflow-hidden bg-black border-round-md">

    @if (permissionState() === false) {
      <div class="flex flex-column align-items-center justify-content-center h-full text-white p-4 text-center">
        <i class="pi pi-ban text-4xl mb-3 text-red-500"></i>
        <span class="font-bold text-lg text-red-500">Không thể truy cập Camera!</span>
        <p class="text-sm mt-2 text-300">
          Vui lòng kiểm tra: <br>
          1. Bạn đã cấp quyền Camera cho trình duyệt chưa?<br>
          2. Có ứng dụng/tab khác đang dùng Camera không?
        </p>
        <p-button label="Thử lại" (click)="retryScan()" styleClass="mt-3 p-button-sm p-button-outlined text-white"></p-button>
      </div>
    }

    @if (visible() && permissionState() !== false) {
      <zxing-scanner
        #scanner
        [enable]="true"
        [formats]="allowedFormats"
        [(device)]="currentDevice"
        (camerasFound)="onCamerasFound($event)"
        (permissionResponse)="onPermissionResponse($event)"
        (scanSuccess)="onScanSuccess($event)"
        (scanError)="onScanError($event)"
        cssClass="w-full h-full object-cover">
      </zxing-scanner>
    }

    @if (hasDevices() && permissionState() === true) {
      <div class="scan-overlay absolute top-0 left-0 w-full h-full pointer-events-none flex align-items-center justify-content-center">
        <div class="viewfinder relative">
          <span class="corner top-left"></span>
          <span class="corner top-right"></span>
          <span class="corner bottom-left"></span>
          <span class="corner bottom-right"></span>
          <div class="laser-line"></div>
        </div>
      </div>
    }

    @if (permissionState() === null) {
      <div class="absolute top-0 left-0 w-full h-full flex align-items-center justify-content-center bg-black-alpha-50 z-5">
        <i class="pi pi-spin pi-spinner text-white text-4xl"></i>
      </div>
    }

  </div>

  <ng-template pTemplate="footer">
    <p-button label="Đóng" icon="pi pi-times" (click)="closeDialog()" styleClass="p-button-text"></p-button>
  </ng-template>
</p-dialog>
